export OpenSSLPath=./openssl-lib
export ExtraLibs=-Wl,--no-as-needed -ldl

CC=emcc
CFLAGS=-I XKCP/bin/generic32/ -I "${OpenSSLPath}/include/"
LFLAGS=-s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc -static -L XKCP/bin/generic32/ -lkeccak -L "${OpenSSLPath}/lib/" -lcrypto ${ExtraLibs}

IMPLEMENTATION_SOURCE = test.c
IMPLEMENTATION_HEADERS= sign.h keccaklib zkproof.h parameters.h merkletree.h


test: $(IMPLEMENTATION_SOURCE) $(IMPLEMENTATION_HEADERS) static
	$(CC) -o test $(IMPLEMENTATION_SOURCE) $(CFLAGS) -static -L ./ -llegroast -std=c11 -O3 -g -march=native 

static: create-mri
	$(CC) -c sign.c zkproof.c merkletree.c $(CFLAGS) $(LFLAGS) -std=c11 -O3 -g -march=native
	emar -rcs liblegroastobj.a sign.o zkproof.o merkletree.o
	emar -M <liblegroast.mri

create-mri:
	rm -f liblegroast.mri
	@echo "  create liblegroast.a\n  addlib liblegroastobj.a\n  addlib XKCP/bin/generic32/libkeccak.a\n  addlib $(OpenSSLPath)/lib/libcrypto.a\n  addlib /usr/lib/x86_64-linux-gnu/libdl.a\n  save\n  end" > liblegroast.mri

keccaklib: 
	(cd XKCP; make generic32/libkeccak.a)

.PHONY: clean
clean:
	rm -rf PQCgenKAT_sign test debug ./XKCP/bin liblegroast.a liblegroastobj.a liblegroast.mri test_offline intermediateValues.txt *.req *.rsp >/dev/null *.o
